<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carta Digital • Demo Intermedio (Dark)</title>
  <meta name="description" content="Carta digital dark: modificadores, combos y WhatsApp.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0e0f10;           /* negro suave */
      --panel:#141518;        /* paneles */
      --panel-2:#1a1c20;      /* paneles secundarios */
      --text:#ffffff;         /* texto principal */
      --muted:#cfd5df;        /* texto suave */
      --brand:#0ea5e9;        /* azul acento (botones) */
      --accent:#ffd60a;       /* AMARILLO títulos */
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    body{ font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); }
    .img-grad::after{ content:""; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));}
    .btn{ display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:.6rem 1rem; color:#fff; font-weight:700; background:var(--brand); box-shadow: 0 6px 16px rgba(14,165,233,.35);}
    .btn:active{ transform: translateY(1px); }
    .btn-outline{ display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:.5rem .9rem; font-weight:700; border:2px solid var(--brand); color:var(--brand); background:transparent;}
    .badge{ font-size:.75rem; font-weight:700; padding:.25rem .5rem; border-radius:999px; background:rgba(0,0,0,.55); color:#fff; border:1px solid var(--border); backdrop-filter: blur(4px); }
    .pill{ white-space:nowrap; padding:.5rem .75rem; border-radius:999px; border:1px solid var(--border); color:var(--muted); background: #0e0f10; }
    .pill.active{ background: var(--panel-2); color:#fff; border-color: rgba(255,214,10,.35); box-shadow: inset 0 0 0 1px rgba(255,214,10,.25); }
    .sticky-cart-shadow{ box-shadow: var(--shadow);}
    dialog{ background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:16px; }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .optchip{ border:1.5px solid var(--border); border-radius:999px; padding:.45rem .7rem; cursor:pointer; color:var(--muted); background:transparent; }
    .optchip.active{ border-color:var(--brand); color:#cbeaff; background:#06212b; font-weight:700;}
    .card{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background: #0b0c0e; }
    .divider{ border-top:1px solid var(--border); }
    .title-yellow{ color: var(--accent); text-shadow: 0 2px 20px rgba(255,214,10,.18); }
    .muted{ color: var(--text); opacity:.92; } /* detalles en BLANCO suave */
    .panel{ background:var(--panel); }
  </style>
</head>
<body>

  <!-- HEADER / HERO -->
  <header class="relative">
    <img src="img/hero-intermedio.jpg" alt="Especial de la casa" class="w-full h-[46vh] object-cover" />
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="absolute inset-x-0 bottom-0 p-4 sm:p-6">
      <div class="max-w-6xl mx-auto text-white">
        <h1 class="text-3xl sm:text-4xl font-extrabold drop-shadow">Carta Visual + Modificadores + Combos</h1>
        <p class="mt-1 text-white/90">Armá tu plato ideal, sumá extras y llevate combos en un toque.</p>
        <div class="mt-3 flex gap-2">
          <a href="#carta" class="btn">Ver Carta</a>
          <a href="#como-funciona" class="btn-outline">¿Cómo funciona?</a>
        </div>
      </div>
    </div>
  </header>

  <!-- NAV CATEGORÍAS -->
  <nav class="sticky top-0 z-40 backdrop-blur border-b" style="background:rgba(14,15,16,.8); border-color:var(--border);">
    <div class="max-w-6xl mx-auto px-4 py-2">
      <div class="flex items-center gap-2 overflow-x-auto">
        <button data-cat="todo" class="pill active">Todo</button>
        <button data-cat="burgers" class="pill">Burgers</button>
        <button data-cat="pizzas" class="pill">Pizzas</button>
        <button data-cat="sides" class="pill">Acompañamientos</button>
        <button data-cat="bebidas" class="pill">Bebidas</button>
        <button data-cat="postres" class="pill">Postres</button>
      </div>
    </div>
  </nav>

  <!-- CARTA -->
  <main id="carta" class="max-w-6xl mx-auto px-4 py-6">
    <section id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">

      <!-- CARD: Burger Doble -->
      <article class="group card data-[hidden=true]:hidden" data-category="burgers" data-id="b1">
        <div class="relative h-60 sm:h-64">
          <img src="img/burger-doble.jpg" alt="Burger Doble" class="w-full h-full object-cover">
          <div class="absolute top-3 left-3 flex gap-2">
            <span class="badge">⭐ Top ventas</span>
            <span class="badge">🍔</span>
          </div>
          <div class="img-grad absolute inset-0"></div>
          <div class="absolute bottom-3 left-3 right-3">
            <h3 class="text-xl font-extrabold title-yellow">Burger Doble</h3>
            <p class="muted text-sm">Doble carne, cheddar, lechuga, tomate, aderezo</p>
            <div class="mt-2 flex items-center justify-between">
              <span class="text-lg font-bold text-white">$5.200</span>
              <button class="btn !py-2 !px-3 text-sm" data-config="b1">Configurar</button>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD: Pizza Muzza -->
      <article class="group card data-[hidden=true]:hidden" data-category="pizzas" data-id="p1">
        <div class="relative h-60 sm:h-64">
          <img src="img/pizza-muzza.jpg" alt="Pizza Muzzarella" class="w-full h-full object-cover">
          <div class="absolute top-3 left-3 flex gap-2">
            <span class="badge">🔥 Promoción</span>
          </div>
          <div class="img-grad absolute inset-0"></div>
          <div class="absolute bottom-3 left-3 right-3">
            <h3 class="text-xl font-extrabold title-yellow">Pizza Muzzarella</h3>
            <p class="muted text-sm">Muzza, orégano, aceitunas</p>
            <div class="mt-2 flex items-center justify-between">
              <span class="text-lg font-bold text-white">$6.000</span>
              <button class="btn !py-2 !px-3 text-sm" data-config="p1">Configurar</button>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD: Papas -->
      <article class="group card data-[hidden=true]:hidden" data-category="sides" data-id="s1">
        <div class="relative h-60 sm:h-64">
          <img src="img/papas-cheddar-2.jpg" alt="Papas con cheddar" class="w-full h-full object-cover">
          <div class="img-grad absolute inset-0"></div>
          <div class="absolute bottom-3 left-3 right-3">
            <h3 class="text-xl font-extrabold title-yellow">Papas Cheddar</h3>
            <p class="muted text-sm">Crocantes con cheddar y verdeo</p>
            <div class="mt-2 flex items-center justify-between">
              <span class="text-lg font-bold text-white">$3.400</span>
              <button class="btn !py-2 !px-3 text-sm" data-add="s1">Agregar</button>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD: Bebida -->
      <article class="group card data-[hidden=true]:hidden" data-category="bebidas" data-id="d1">
        <div class="relative h-60 sm:h-64">
          <img src="img/gaseosa-500.jpg" alt="Gaseosa 500 ml" class="w-full h-full object-cover">
          <div class="img-grad absolute inset-0"></div>
          <div class="absolute bottom-3 left-3 right-3">
            <h3 class="text-xl font-extrabold title-yellow">Gaseosa 500 ml</h3>
            <p class="muted text-sm">Cola, lima-limón, naranja</p>
            <div class="mt-2 flex items-center justify-between">
              <span class="text-lg font-bold text-white">$1.500</span>
              <button class="btn !py-2 !px-3 text-sm" data-add="d1">Agregar</button>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD: Cheesecake -->
      <article class="group card data-[hidden=true]:hidden" data-category="postres" data-id="ds1">
        <div class="relative h-60 sm:h-64">
          <img src="img/cheesecake.jpg" alt="Cheesecake" class="w-full h-full object-cover">
          <div class="img-grad absolute inset-0"></div>
          <div class="absolute bottom-3 left-3 right-3">
            <h3 class="text-xl font-extrabold title-yellow">Cheesecake</h3>
            <p class="muted text-sm">Frutos rojos y base crocante</p>
            <div class="mt-2 flex items-center justify-between">
              <span class="text-lg font-bold text-white">$3.100</span>
              <button class="btn !py-2 !px-3 text-sm" data-add="ds1">Agregar</button>
            </div>
          </div>
        </div>
      </article>

    </section>

    <!-- CÓMO FUNCIONA -->
    <section id="como-funciona" class="mt-12 grid md:grid-cols-3 gap-6">
      <div class="p-5 panel rounded-2xl border" style="border-color:var(--border);">
        <h4 class="font-extrabold title-yellow">1) Configurá</h4>
        <p class="text-sm" style="color:var(--text); opacity:.92">Elegí tamaño, punto de cocción y extras.</p>
      </div>
      <div class="p-5 panel rounded-2xl border" style="border-color:var(--border);">
        <h4 class="font-extrabold title-yellow">2) Sumá combos</h4>
        <p class="text-sm" style="color:var(--text); opacity:.92">Aprovechá upsells automáticos.</p>
      </div>
      <div class="p-5 panel rounded-2xl border" style="border-color:var(--border);">
        <h4 class="font-extrabold title-yellow">3) WhatsApp</h4>
        <p class="text-sm" style="color:var(--text); opacity:.92">Pedido armado al instante.</p>
      </div>
    </section>
  </main>

  <!-- STICKY CART -->
  <div id="stickyCart" class="fixed inset-x-0 bottom-0 z-50 border-t" style="background:rgba(20,21,24,.98); border-color:var(--border); box-shadow:var(--shadow);">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <button id="openCart" class="flex-1 btn-outline">Ver carrito (<span id="cartCount">0</span>)</button>
      <button id="checkout" class="btn flex-1">Confirmar por WhatsApp</button>
    </div>
  </div>

  <!-- DRAWER CARRITO -->
  <div id="drawer" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <aside class="absolute right-0 top-0 h-full w-full sm:w-[440px] panel p-5 overflow-y-auto border-l" style="border-color:var(--border);">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-extrabold title-yellow">Tu pedido</h3>
        <button class="btn-outline" data-close>Cerrar</button>
      </div>
      <ul id="cartList" class="mt-4 space-y-4"></ul>
      <div class="mt-6 divider pt-4 grid grid-cols-2 gap-2 items-center">
        <div class="font-extrabold">Total</div>
        <div id="cartTotal" class="text-lg font-extrabold text-right">$0</div>
        <input id="clienteNombre" class="border rounded-xl px-3 py-2 col-span-2" placeholder="Tu nombre" style="background:#0b0c0e; border-color:var(--border); color:var(--text);" />
        <select id="clienteModo" class="border rounded-xl px-3 py-2" style="background:#0b0c0e; border-color:var(--border); color:var(--text);">
          <option value="Retiro">Retiro</option>
          <option value="Delivery">Delivery</option>
        </select>
        <input id="clienteHora" class="border rounded-xl px-3 py-2" placeholder="Hora estimada (ej: 20:30)" style="background:#0b0c0e; border-color:var(--border); color:var(--text);" />
      </div>
      <button id="checkout2" class="btn w-full mt-4">Enviar por WhatsApp</button>
      <p class="text-xs" style="color:var(--muted);">*Demo: precios y horarios ilustrativos.</p>
    </aside>
  </div>

  <!-- MODAL CONFIGURACIÓN PRODUCTO -->
  <dialog id="configModal" class="w-[95vw] max-w-xl p-0">
    <form method="dialog" class="p-0">
      <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border);">
        <div>
          <h3 id="cfgTitle" class="text-xl font-extrabold title-yellow">Configurar</h3>
          <p id="cfgDesc" class="text-sm" style="color:var(--text); opacity:.92">Elegí opciones</p>
        </div>
        <button class="btn-outline" value="cancel">Cerrar</button>
      </div>
      <div class="p-4 space-y-5">
        <section>
          <h4 class="font-bold title-yellow">Tamaño</h4>
          <div id="optSize" class="mt-2 flex flex-wrap gap-2"></div>
        </section>
        <section id="secDoneness" class="hidden">
          <h4 class="font-bold title-yellow">Punto de cocción</h4>
          <div id="optDoneness" class="mt-2 flex flex-wrap gap-2"></div>
        </section>
        <section>
          <h4 class="font-bold title-yellow">Extras</h4>
          <div id="optExtras" class="mt-2 flex flex-wrap gap-2"></div>
        </section>
        <div class="flex items-center justify-between">
          <div class="text-sm" style="color:var(--muted);">Subtotal</div>
          <div id="cfgSubtotal" class="text-lg font-extrabold text-white">$0</div>
        </div>
        <div class="flex items-center justify-end gap-3">
          <button class="btn-outline" value="cancel">Cancelar</button>
          <button id="cfgAddBtn" class="btn" value="default">Agregar</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- MODAL UPSELL / COMBO -->
  <dialog id="upsellModal" class="w-[95vw] max-w-md p-0">
    <form method="dialog" class="p-0">
      <div class="p-4 border-b flex items-center justify-between" style="border-color:var(--border);">
        <h3 class="text-xl font-extrabold title-yellow">Sumá el Combo y ahorrá</h3>
        <button class="btn-outline" value="close">Cerrar</button>
      </div>
      <div class="p-4 space-y-3">
        <p>🍟 Papas + 🥤 Bebida a <span class="font-bold" style="color:var(--accent);">precio promo</span>.</p>
        <div class="flex items-center justify-between rounded-xl p-3" style="background:var(--panel-2); border:1px solid var(--border);">
          <div>
            <div class="font-bold">Combo Clásico</div>
            <div class="text-sm" style="color:var(--muted);">Papas medianas + Gaseosa 500</div>
          </div>
          <div class="text-right">
            <div class="line-through text-sm" style="color:#a5adba;">$2.900</div>
            <div class="text-lg font-extrabold" style="color:#22c55e;">$2.400</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <button class="btn-outline" value="no">No gracias</button>
          <button id="upsellYes" class="btn" value="yes">Agregar combo</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- FOOTER -->
  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-sm" style="color:var(--muted);">
    Demo Intermedio (Dark) • Modificadores + Combos + WhatsApp • Hecho para antojar 😋
  </footer>

  <!-- SCRIPT (idéntico a la demo 2 anterior, solo cambia estilos) -->
  <script>
    // ======= CONFIG =======
    const BRAND_NAME = "Demo Restaurante Pro";
    const WHATSAPP_NUMBER = "5493751000000"; // Reemplazar
    const CURRENCY = "ARS";
    window.dataLayer = window.dataLayer || [];

    // ======= CATÁLOGO =======
    const CATALOG = {
      b1: {
        id:"b1", name:"Burger Doble", base:5200, category:"burgers",
        schedule:{ start:"11:00", end:"23:45" }, doneness:true,
        sizes:[ {name:"Simple",delta:-900},{name:"Doble",delta:0,default:true},{name:"Triple",delta:1200} ],
        extras:[ {name:"+Queso",price:400},{name:"+Bacon",price:600},{name:"+Huevo",price:300},{name:"Sin cebolla",price:0} ],
        upsell:{ bundleName:"Combo Clásico", items:[{id:"s1",qty:1},{id:"d1",qty:1}], promoPrice:2400 }
      },
      p1: {
        id:"p1", name:"Pizza Muzzarella", base:6000, category:"pizzas",
        schedule:{ start:"19:00", end:"23:59" }, doneness:false,
        sizes:[ {name:"8 porciones",delta:0,default:true},{name:"12 porciones",delta:1800} ],
        extras:[ {name:"+Aceitunas extra",price:300},{name:"+Muzza extra",price:700},{name:"Mitad y mitad",price:500} ],
        upsell:null
      },
      s1: {
        id:"s1", name:"Papas Cheddar", base:3400, category:"sides",
        schedule:{ start:"11:00", end:"23:59" }, doneness:false,
        sizes:[ {name:"Chicas",delta:-500},{name:"Medianas",delta:0,default:true},{name:"Grandes",delta:700} ],
        extras:[ {name:"+Bacon",price:600},{name:"+Verdeo extra",price:200} ],
        upsell:null
      },
      d1: {
        id:"d1", name:"Gaseosa 500 ml", base:1500, category:"bebidas",
        schedule:{ start:"10:00", end:"23:59" }, doneness:false,
        sizes:[ {name:"350 ml",delta:-300},{name:"500 ml",delta:0,default:true},{name:"1 L",delta:900} ],
        extras:[ {name:"Sin hielo",price:0} ],
        upsell:null
      },
      ds1: {
        id:"ds1", name:"Cheesecake", base:3100, category:"postres",
        schedule:{ start:"10:00", end:"23:59" }, doneness:false,
        sizes:[ {name:"Porción",delta:0,default:true} ],
        extras:[ {name:"Salsa extra frutos rojos",price:300} ],
        upsell:null
      }
    };

    // ======= UTILS =======
    const fmt = (n) => new Intl.NumberFormat('es-AR',{style:'currency', currency:CURRENCY}).format(n);
    const nowStr = ()=>{ const d=new Date(); return d.toTimeString().slice(0,5); };
    function withinSchedule(sch){ if(!sch) return true; const t=nowStr(); return t>=sch.start && t<=sch.end; }

    // ======= STATE =======
    const CART = { items:[], total:0 };
    const pushEvent = (name, params={}) => { window.dataLayer.push({ event:name, ...params }); };

    // ======= FILTROS =======
    function applyCategory(cat){
      document.querySelectorAll('#grid article').forEach(card=>{
        const id = card.getAttribute('data-id');
        const prod = CATALOG[id];
        const okCat = (cat==='todo' || prod?.category===cat);
        const okTime = withinSchedule(prod?.schedule);
        card.dataset.hidden = (okCat && okTime) ? "false" : "true";
      });
      document.querySelectorAll('nav .pill').forEach(p=>p.classList.remove('active'));
      document.querySelector(`nav .pill[data-cat="${cat}"]`)?.classList.add('active');
    }
    document.querySelectorAll('nav [data-cat]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        applyCategory(btn.getAttribute('data-cat'));
        pushEvent('filter_category',{ category:btn.getAttribute('data-cat') });
      });
    });
    applyCategory('todo');

    // ======= MODALES =======
    const configModal = document.getElementById('configModal');
    const upsellModal = document.getElementById('upsellModal');
    let currentCfg = null;

    document.querySelectorAll('[data-config]').forEach(btn=>{
      btn.addEventListener('click', ()=> openConfig(btn.getAttribute('data-config')));
    });
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=> addConfiguredToCart({ id:btn.getAttribute('data-add'), size:null, doneness:null, extras:[] }));
    });

    function openConfig(id){
      const p = CATALOG[id]; if(!p) return;
      document.getElementById('cfgTitle').textContent = p.name;
      document.getElementById('cfgDesc').textContent  = "Personalizá tu pedido";

      const sizeWrap = document.getElementById('optSize'); sizeWrap.innerHTML="";
      p.sizes?.forEach(s=>{
        const el = document.createElement('button');
        el.type="button"; el.className="optchip"+(s.default?" active":"");
        el.textContent = s.name + (s.delta?` (${s.delta>0?"+":""}${fmt(s.delta)})`:"");
        el.onclick = ()=>{
          sizeWrap.querySelectorAll('.optchip').forEach(c=>c.classList.remove('active'));
          el.classList.add('active'); currentCfg.size = s; updateCfgSubtotal();
        };
        sizeWrap.appendChild(el);
      });

      const secDon = document.getElementById('secDoneness');
      const donWrap= document.getElementById('optDoneness'); donWrap.innerHTML="";
      if(p.doneness){
        secDon.classList.remove('hidden');
        ["Jugosa","A punto","Bien cocida"].forEach((d,idx)=>{
          const el=document.createElement('button');
          el.type="button"; el.className="optchip"+(idx===1?" active":"");
          el.textContent=d;
          el.onclick=()=>{ donWrap.querySelectorAll('.optchip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); currentCfg.doneness=d; };
          donWrap.appendChild(el);
        });
      }else{ secDon.classList.add('hidden'); }

      const exWrap = document.getElementById('optExtras'); exWrap.innerHTML="";
      p.extras?.forEach(ex=>{
        const el=document.createElement('button');
        el.type="button"; el.className="optchip"; el.textContent = ex.name + (ex.price?` (${fmt(ex.price)})`:"");
        el.onclick=()=>{
          if(el.classList.contains('active')){
            el.classList.remove('active');
            currentCfg.extras = currentCfg.extras.filter(e=>e.name!==ex.name);
          }else{
            el.classList.add('active');
            currentCfg.extras.push(ex);
          }
          updateCfgSubtotal();
        };
        exWrap.appendChild(el);
      });

      currentCfg = { id, size: p.sizes?.find(s=>s.default) || p.sizes?.[0] || null, doneness: p.doneness ? "A punto" : null, extras: [] };
      updateCfgSubtotal();
      configModal.showModal();
      pushEvent('open_config',{ product_id:id, product_name:p.name });
    }

    function cfgPrice(){
      const p = CATALOG[currentCfg.id];
      let subtotal = p.base + (currentCfg.size?.delta || 0);
      currentCfg.extras.forEach(ex => subtotal += (ex.price||0));
      return subtotal;
    }
    function updateCfgSubtotal(){ document.getElementById('cfgSubtotal').textContent = fmt(cfgPrice()); }

    document.getElementById('cfgAddBtn').addEventListener('click',(e)=>{
      e.preventDefault();
      addConfiguredToCart(currentCfg);
      configModal.close();
      const prod = CATALOG[currentCfg.id];
      if(prod.upsell){ upsellModal.showModal(); pendingUpsell = prod.upsell; }
    });

    // ======= CARRITO =======
    const drawer = document.getElementById('drawer');
    document.getElementById('openCart').onclick = ()=>{ drawer.classList.remove('hidden'); };
    drawer.querySelectorAll('[data-close]').forEach(el => el.onclick = ()=> drawer.classList.add('hidden'));

    function addConfiguredToCart(cfg){
      const p = CATALOG[cfg.id]; if(!p) return;
      const price = p.base + (cfg.size?.delta || 0) + (cfg.extras||[]).reduce((a,b)=>a+(b.price||0),0);
      const key = JSON.stringify({ id:cfg.id, size:cfg.size?.name||null, doneness:cfg.doneness||null, extras:(cfg.extras||[]).map(e=>e.name).sort() });
      const idx = CART.items.findIndex(i => i.key===key);
      if(idx>-1){ CART.items[idx].qty++; } else {
        CART.items.push({
          key, id:cfg.id, name:p.name,
          detail:[
            cfg.size?.name?`Tamaño: ${cfg.size.name}`:null,
            cfg.doneness?`Punto: ${cfg.doneness}`:null,
            (cfg.extras?.length?`Extras: ${cfg.extras.map(e=>e.name).join(", ")}`:null)
          ].filter(Boolean).join(" • "),
          unit:price, qty:1
        });
      }
      recalc(); pingCart(); pushEvent('add_to_cart',{ item_id:p.id, item_name:p.name, value:price });
    }

    function changeQty(key, delta){
      const idx = CART.items.findIndex(it => it.key===key);
      if(idx===-1) return;
      CART.items[idx].qty += delta;
      if(CART.items[idx].qty<=0){ CART.items.splice(idx,1); }
      recalc();
    }

    function recalc(){
      CART.total = CART.items.reduce((a,b)=>a + b.unit*b.qty, 0);
      document.getElementById('cartCount').textContent = CART.items.reduce((a,b)=>a+b.qty,0);
      document.getElementById('cartTotal').textContent = fmt(CART.total);
      renderList();
      window.__CART__ = { brand: BRAND_NAME, items: CART.items.map(i=>({ qty:i.qty, name:i.name, detail:i.detail, price:i.unit })), total: CART.total };
    }

    function renderList(){
      const ul = document.getElementById('cartList'); ul.innerHTML = '';
      if(CART.items.length===0){ ul.innerHTML = '<li style="color:var(--muted);">Tu carrito está vacío.</li>'; return; }
      CART.items.forEach(i=>{
        const li = document.createElement('li');
        li.className = "grid grid-cols-[1fr_auto] gap-2";
        li.innerHTML = `
          <div>
            <div class="font-semibold title-yellow">${i.name}</div>
            ${i.detail ? `<div class="text-sm" style="color:var(--text); opacity:.92">${i.detail}</div>` : ""}
            <div class="text-sm" style="color:var(--text); opacity:.92">${fmt(i.unit)} c/u</div>
          </div>
          <div class="flex items-center gap-2 self-center">
            <button class="btn-outline !px-3 !py-1" data-dec='${i.key}'>-</button>
            <span class="w-6 text-center font-semibold">${i.qty}</span>
            <button class="btn-outline !px-3 !py-1" data-inc='${i.key}'>+</button>
          </div>
        `;
        ul.appendChild(li);
      });
      ul.querySelectorAll('[data-inc]').forEach(b=>b.onclick=()=>changeQty(b.getAttribute('data-inc'),+1));
      ul.querySelectorAll('[data-dec]').forEach(b=>b.onclick=()=>changeQty(b.getAttribute('data-dec'),-1));
    }

    // ======= UPSELL =======
    let pendingUpsell = null;
    document.getElementById('upsellYes')?.addEventListener('click',(e)=>{
      e.preventDefault();
      if(!pendingUpsell) return;
      const { items, promoPrice, bundleName } = pendingUpsell;
      const key = "bundle:"+bundleName;
      const idx = CART.items.findIndex(i=>i.key===key);
      if(idx>-1){ CART.items[idx].qty++; } else {
        CART.items.push({ key, id:"bundle", name:bundleName, detail:"Incluye: Papas + Gaseosa", unit:promoPrice, qty:1 });
      }
      recalc(); upsellModal.close(); pushEvent('add_upsell',{ bundle:bundleName, value:promoPrice }); pendingUpsell = null;
    });

    // ======= WHATSAPP =======
    function buildOrderMessage(){
      const nombre = document.getElementById('clienteNombre')?.value || "—";
      const modo   = document.getElementById('clienteModo')?.value || "—";
      const hora   = document.getElementById('clienteHora')?.value || "—";
      const lines = CART.items.map(i => `- ${i.qty}× ${i.name}${i.detail?` (${i.detail})`:''} — ${fmt(i.unit*i.qty)}`);
      const msg = [
        `Pedido ${BRAND_NAME}:`,
        ...lines,
        `Total estimado: ${fmt(CART.total)}`,
        `Nombre: ${nombre} | ${modo} | Hora: ${hora}`
      ].join("\n");
      return encodeURIComponent(msg);
    }
    function goWhatsApp(){
      if(CART.items.length===0){ alert("Tu carrito está vacío."); return; }
      window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${buildOrderMessage()}`;
      pushEvent('checkout',{ value:CART.total, items:CART.items.length });
    }
    document.getElementById('checkout').onclick  = goWhatsApp;
    document.getElementById('checkout2').onclick = goWhatsApp;

    // Drawer overlay close
    document.querySelectorAll('#drawer [data-close]').forEach(el => el.onclick = ()=> drawer.classList.add('hidden'));

    // Ping UX
    function pingCart(){ const el = document.getElementById('stickyCart'); el.animate([{transform:'translateY(0)'},{transform:'translateY(-4px)'},{transform:'translateY(0)'}],{ duration:220, easing:'ease-out' }); }

    // INIT
    recalc();
  </script>
</body>
</html>
